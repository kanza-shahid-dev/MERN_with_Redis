name: Deploy to EC2

on:
  push:
    branches: [main]

env:
  # DOCKER_COMPOSE_VERSION: "v2.27.0"
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/application"
          strip_components: 1

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/application

            # # Install Docker Compose if not exists
            # if ! command -v docker-compose &> /dev/null; then
            #   sudo curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            #   sudo chmod +x /usr/local/bin/docker-compose
            # fi

            # # Stop and remove existing containers
            # sudo docker compose down

            # Pull latest images and start services
            sudo docker compose up -d --build

            # Clean up unused images
            sudo docker image prune -f
            sudo docker system prune -af
            echo "Deployment completed successfully!"
